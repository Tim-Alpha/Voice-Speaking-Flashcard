<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Flashy</title>
    <!-- Import Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        /* Modern Color Palette */
        --primary: #6366f1; /* Indigo 500 */
        --primary-hover: #4f46e5;
        --primary-light: #e0e7ff;

        --bg-gradient-start: #f3f4f6;
        --bg-gradient-end: #e5e7eb;

        --surface: #ffffff;
        --surface-translucent: rgba(255, 255, 255, 0.85);

        --text-main: #1e293b; /* Slate 800 */
        --text-muted: #64748b; /* Slate 500 */
        --text-light: #94a3b8;

        --danger: #ef4444;
        --danger-light: #fee2e2;

        --nav-height: 70px; /* Slightly taller for modern look */
        --header-height: 60px;

        /* Shadows */
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -1px rgb(0 0 0 / 0.06);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -2px rgb(0 0 0 / 0.05);
        --shadow-card: 0 20px 25px -5px rgb(0 0 0 / 0.1),
          0 10px 10px -5px rgb(0 0 0 / 0.04);

        --radius-lg: 1.5rem;
        --radius-md: 1rem;
        --radius-sm: 0.5rem;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        background: linear-gradient(135deg, #f0f4ff 0%, #eef2ff 100%);
        color: var(--text-main);
        height: 100vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      /* --- Layout --- */
      #app {
        flex: 1;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        max-width: 700px; /* Constrain width on desktop */
        width: 100%;
        margin: 0 auto;
      }

      .view {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 1.5rem;
        padding-bottom: calc(var(--nav-height) + 2rem);
        display: none;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      .view.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
        z-index: 1;
      }

      /* --- Header --- */
      .app-header {
        height: var(--header-height);
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--surface-translucent);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        z-index: 10;
        flex-shrink: 0;
      }

      .app-header h1 {
        font-size: 1.1rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        color: var(--text-main);
      }

      /* --- Navigation --- */
      .bottom-nav {
        height: var(--nav-height);
        background: var(--surface-translucent);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-around;
        align-items: center;
        position: fixed;
        bottom: 0;
        width: 100%;
        z-index: 20;
        padding-bottom: env(safe-area-inset-bottom);
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.03);
      }

      .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        color: var(--text-light);
        font-size: 0.7rem;
        font-weight: 600;
        text-decoration: none;
        width: 100%;
        height: 100%;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
      }

      .nav-item svg {
        width: 24px;
        height: 24px;
        stroke-width: 2;
        transition: transform 0.2s;
      }

      .nav-item.active {
        color: var(--primary);
      }

      .nav-item.active svg {
        transform: translateY(-2px);
        stroke-width: 2.5;
      }

      /* --- Components --- */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius-md);
        font-weight: 600;
        font-size: 0.95rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }

      .btn:active {
        transform: scale(0.96);
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      }

      .btn-primary:hover {
        background-color: var(--primary-hover);
        box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
      }

      .btn-danger {
        background-color: var(--danger-light);
        color: var(--danger);
      }

      .btn-danger:active,
      .btn-danger:hover {
        background-color: var(--danger);
        color: white;
      }

      .btn-ghost {
        background: transparent;
        color: var(--text-muted);
        padding: 0.5rem;
        border-radius: 50%;
      }

      .btn-ghost:hover {
        background: rgba(0, 0, 0, 0.05);
        color: var(--text-main);
      }

      .btn-block {
        width: 100%;
      }

      .btn-icon-only {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .input-field {
        width: 100%;
        padding: 1rem 1.25rem;
        border: 2px solid transparent;
        border-radius: var(--radius-md);
        font-size: 1rem;
        background: #f1f5f9;
        color: var(--text-main);
        margin-bottom: 1.5rem;
        transition: all 0.2s;
        font-family: inherit;
      }

      .input-field:focus {
        outline: none;
        background: var(--surface);
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
      }

      .label {
        display: block;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
        margin-left: 0.25rem;
      }

      /* --- View: Study --- */
      .study-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        margin: 0 auto;
      }

      .settings-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background: var(--surface);
        border-radius: 100px;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(0, 0, 0, 0.03);
      }

      .settings-bar select {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 0.8rem;
        color: var(--text-main);
        outline: none;
      }

      .card-wrapper {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        perspective: 1200px;
        margin: 1rem 0 2rem 0;
        min-height: 320px;
      }

      .flashcard {
        width: 100%;
        height: 100%;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy flip */
        cursor: pointer;
      }

      .flashcard.flipped {
        transform: rotateY(180deg);
      }

      .card-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        background: var(--surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-card);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2.5rem 2rem;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.5);
      }

      .card-face.back {
        transform: rotateY(180deg);
        background: linear-gradient(
          135deg,
          #ecfdf5 0%,
          #ffffff 100%
        ); /* Subtle Green tint */
        border: 2px solid #10b981;
        overflow: hidden;
        justify-content: flex-start;
        padding-top: 3.5rem;
        padding-bottom: 0;
      }

      .card-face.back .card-content::-webkit-scrollbar {
        width: 3px;
      }

      .card-face.back .card-content::-webkit-scrollbar-track {
        background: transparent;
      }

      .card-face.back .card-content::-webkit-scrollbar-thumb {
        background: #10b981;
        border-radius: 4px;
      }

      .card-face.back .card-content::-webkit-scrollbar-thumb:hover {
        background: #059669;
      }

      .card-face.front {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      }

      .card-content {
        font-size: 2rem;
        font-weight: 800;
        line-height: 1.3;
        margin-bottom: 2rem;
        color: var(--text-main);
        word-break: break-word;
      }

      .card-face.back .card-content {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        overflow-x: hidden;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        text-align: left;
      }

      .card-face.back .card-content.long-text {
        font-size: 1.2rem;
        line-height: 1.5;
      }

      .card-hint {
        position: absolute;
        top: 2rem;
        font-size: 0.7rem;
        font-weight: 800;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--text-light);
      }

      .card-face.back .card-hint {
        color: #10b981;
      }

      .speak-btn {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: white;
        border: 1px solid #e2e8f0;
        color: var(--primary);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: var(--shadow-md);
        position: absolute;
        bottom: 2rem;
        flex-shrink: 0;
      }

      .card-face.back .speak-btn {
        position: relative;
        bottom: auto;
        margin-top: auto;
        margin-bottom: 1.5rem;
        align-self: center;
      }

      .speak-btn:hover {
        transform: scale(1.1);
        background: var(--primary);
        color: white;
        border-color: var(--primary);
      }

      .speak-btn svg {
        width: 24px;
        height: 24px;
      }

      .study-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 1rem;
        gap: 1.5rem;
      }

      .progress-indicator {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--text-muted);
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        box-shadow: var(--shadow-sm);
      }

      /* --- View: Create --- */
      .create-container {
        max-width: 600px;
        margin: 0 auto;
      }

      .form-card {
        background: var(--surface);
        padding: 2rem;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
      }

      /* --- View: Manage --- */
      .manage-container {
        max-width: 600px;
        margin: 0 auto;
      }

      .deck-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 1.25rem;
        background: var(--primary); /* Vibrant header for stats */
        background: linear-gradient(135deg, var(--primary) 0%, #4338ca 100%);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-md);
        color: white;
      }

      .deck-stats span {
        color: white !important;
        font-size: 1.1rem;
      }

      .card-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding-bottom: 2rem;
      }

      .list-item {
        background: var(--surface);
        padding: 1.25rem;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid rgba(0, 0, 0, 0.03);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .list-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .list-text {
        flex: 1;
        margin-right: 1rem;
        overflow: hidden;
      }

      .list-front {
        font-weight: 700;
        font-size: 1.05rem;
        margin-bottom: 0.25rem;
        color: var(--text-main);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .list-back {
        font-size: 0.9rem;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* --- Utilities --- */
      .empty-state {
        text-align: center;
        padding: 4rem 1rem;
        color: var(--text-light);
        font-weight: 500;
      }

      .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        background: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(4px);
        color: white;
        padding: 1rem 2rem;
        border-radius: 100px;
        font-weight: 600;
        font-size: 0.9rem;
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        pointer-events: none;
        z-index: 100;
        box-shadow: var(--shadow-lg);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <h1 id="headerTitle">Study Mode</h1>
    </header>

    <div id="app">
      <!-- VIEW 1: STUDY -->
      <div id="view-study" class="view active">
        <div class="study-container">
          <div class="settings-bar">
            <select id="voiceSelect" style="max-width: 150px; cursor: pointer">
              <option value="">Default Voice</option>
            </select>
            <div style="display: flex; align-items: center; gap: 0.75rem">
              <input
                type="checkbox"
                id="autoSpeakToggle"
                style="
                  width: 18px;
                  height: 18px;
                  accent-color: var(--primary);
                  cursor: pointer;
                "
              />
              <label
                for="autoSpeakToggle"
                style="
                  font-size: 0.9rem;
                  margin: 0;
                  font-weight: 600;
                  cursor: pointer;
                  color: var(--text-main);
                "
                >Auto-Speak</label
              >
            </div>
          </div>

          <div class="card-wrapper" id="cardContainer">
            <div class="flashcard" id="flashcard">
              <div class="card-face front">
                <div class="card-hint">Question</div>
                <div class="card-content" id="cardFrontText">Loading...</div>
                <button
                  class="speak-btn"
                  id="speakFrontBtn"
                  aria-label="Speak Question"
                >
                  <svg
                    width="24"
                    height="24"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
                    ></path>
                  </svg>
                </button>
              </div>
              <div class="card-face back">
                <div class="card-hint">Answer</div>
                <div class="card-content" id="cardBackText">Loading...</div>
                <button
                  class="speak-btn"
                  id="speakBackBtn"
                  aria-label="Speak Answer"
                >
                  <svg
                    width="24"
                    height="24"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div class="study-controls">
            <button
              class="btn btn-primary btn-icon-only"
              id="prevBtn"
              aria-label="Previous Card"
            >
              <svg
                width="28"
                height="28"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2.5"
                  d="M15 19l-7-7 7-7"
                ></path>
              </svg>
            </button>
            <span class="progress-indicator" id="progressText">1 / 5</span>
            <button
              class="btn btn-primary btn-icon-only"
              id="nextBtn"
              aria-label="Next Card"
            >
              <svg
                width="28"
                height="28"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2.5"
                  d="M9 5l7 7-7 7"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- VIEW 2: CREATE -->
      <div id="view-create" class="view">
        <div class="create-container">
          <div class="form-card">
            <form id="addCardForm">
              <label class="label" for="newFront">Question</label>
              <textarea
                class="input-field"
                id="newFront"
                rows="3"
                placeholder="What do you want to learn?"
                required
              ></textarea>

              <label class="label" for="newBack">Answer</label>
              <textarea
                class="input-field"
                id="newBack"
                rows="3"
                placeholder="The correct response..."
                required
              ></textarea>

              <button
                type="submit"
                class="btn btn-primary btn-block"
                style="margin-top: 1rem"
              >
                <svg
                  width="20"
                  height="20"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  style="margin-right: 8px"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4v16m8-8H4"
                  ></path>
                </svg>
                Add Card
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- VIEW 3: MANAGE -->
      <div id="view-manage" class="view">
        <div class="manage-container">
          <div class="deck-stats">
            <span id="deckCount">Total Cards: 0</span>
            <button
              class="btn"
              id="clearDeckBtn"
              style="
                background: rgba(255, 255, 255, 0.2);
                color: white;
                border: 1px solid rgba(255, 255, 255, 0.3);
                font-size: 0.8rem;
                padding: 0.5rem 1rem;
              "
            >
              Clear All
            </button>
          </div>
          <ul class="card-list" id="cardList">
            <!-- Items -->
          </ul>
        </div>
      </div>
    </div>

    <nav class="bottom-nav">
      <div
        class="nav-item active"
        data-target="view-study"
        onclick="switchView('view-study')"
      >
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
          ></path>
        </svg>
        <span>Study</span>
      </div>
      <div
        class="nav-item"
        data-target="view-create"
        onclick="switchView('view-create')"
      >
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"
          ></path>
        </svg>
        <span>Create</span>
      </div>
      <div
        class="nav-item"
        data-target="view-manage"
        onclick="switchView('view-manage')"
      >
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
          ></path>
        </svg>
        <span>Manage</span>
      </div>
    </nav>

    <div id="toast" class="toast">
      <svg
        width="20"
        height="20"
        fill="none"
        stroke="#4ade80"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M5 13l4 4L19 7"
        ></path>
      </svg>
      Card Added!
    </div>

    <script>
      // --- State ---
      const STORAGE_KEY = "flashcards_v2";
      const DEMO_DECK = [
        { id: 1, front: "Hello", back: "Hola" },
        { id: 2, front: "Good Morning", back: "Buenos DÃ­as" },
        { id: 3, front: "Thank you", back: "Gracias" },
      ];

      let deck = [];
      let currentIndex = 0;
      let isFlipped = false;
      let voices = [];
      let synth = window.speechSynthesis;

      // --- Elements ---
      const views = document.querySelectorAll(".view");
      const navItems = document.querySelectorAll(".nav-item");
      const headerTitle = document.getElementById("headerTitle");

      // Study Elements
      const flashcard = document.getElementById("flashcard");
      const cardFrontText = document.getElementById("cardFrontText");
      const cardBackText = document.getElementById("cardBackText");
      const progressText = document.getElementById("progressText");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const voiceSelect = document.getElementById("voiceSelect");
      const autoSpeakToggle = document.getElementById("autoSpeakToggle");

      // --- Init ---
      function init() {
        // Check for localStorage support
        try {
          localStorage.setItem("_test", "test");
          localStorage.removeItem("_test");
        } catch (error) {
          console.error("localStorage not available:", error);
          showToast("Storage not available - changes won't persist", "delete");
        }

        loadDeck();
        
        // Load voices with retry for WebView
        loadVoices();
        setTimeout(loadVoices, 1000); // Retry after 1 second
        
        renderStudy();
        renderManage();

        // Event Listeners
        flashcard.addEventListener("click", handleCardClick);
        prevBtn.addEventListener("click", prevCard);
        nextBtn.addEventListener("click", nextCard);

        // Swipe Gestures
        const cardContainer = document.getElementById("flashcard");
        let touchStartX = 0;
        let touchEndX = 0;

        cardContainer.addEventListener(
          "touchstart",
          (e) => {
            touchStartX = e.changedTouches[0].screenX;
          },
          { passive: true }
        );

        cardContainer.addEventListener(
          "touchend",
          (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
          },
          { passive: true }
        );

        function handleSwipe() {
          const threshold = 50; // Min distance to be considered a swipe
          const swipeDistance = touchEndX - touchStartX;

          if (Math.abs(swipeDistance) > threshold) {
            if (swipeDistance < 0) {
              // Swipe Left -> Next Card
              nextCard();
            } else {
              // Swipe Right -> Prev Card
              prevCard();
            }
          }
        }

        // Form submission - use both submit and click handlers for WebView compatibility
        const addCardForm = document.getElementById("addCardForm");
        addCardForm.addEventListener("submit", handleAddCard);
        
        // Also handle button click directly as fallback
        const submitBtn = addCardForm.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.addEventListener("click", (e) => {
            // Let the form submit handler do the work, but ensure it fires
            if (!addCardForm.checkValidity()) {
              e.preventDefault();
              showToast("Please fill both fields!", "delete");
            }
          });
        }
        document
          .getElementById("clearDeckBtn")
          .addEventListener("click", handleClearDeck);

        document
          .getElementById("speakFrontBtn")
          .addEventListener("click", (e) => {
            e.stopPropagation();
            speak(deck[currentIndex]?.front);
          });
        document
          .getElementById("speakBackBtn")
          .addEventListener("click", (e) => {
            e.stopPropagation();
            speak(deck[currentIndex]?.back);
          });

        // Voice loading for WebView - multiple strategies
        if (synth && synth.onvoiceschanged !== undefined) {
          synth.onvoiceschanged = loadVoices;
        }
        
        // Additional retry for WebView voice loading
        if (synth) {
          // Some WebViews need a user interaction first
          document.addEventListener("click", () => {
            if (voices.length === 0) {
              loadVoices();
            }
          }, { once: true });
        }
      }

      // --- Navigation ---
      window.switchView = function (viewId) {
        // Update Views
        views.forEach((view) => {
          if (view.id === viewId) {
            view.classList.add("active");
          } else {
            view.classList.remove("active");
          }
        });

        // Update Nav
        navItems.forEach((item) => {
          if (item.dataset.target === viewId) {
            item.classList.add("active");
          } else {
            item.classList.remove("active");
          }
        });

        // Update Header
        switch (viewId) {
          case "view-study":
            headerTitle.textContent = "Study Mode";
            renderStudy();
            break;
          case "view-create":
            headerTitle.textContent = "Add New Card";
            break;
          case "view-manage":
            headerTitle.textContent = "Manage Deck";
            renderManage();
            break;
        }
      };

      // --- Data Logic ---
      function loadDeck() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) {
            deck = JSON.parse(stored);
          } else {
            deck = [...DEMO_DECK];
            saveDeck();
          }
        } catch (error) {
          console.error("Error loading deck:", error);
          deck = [...DEMO_DECK];
          showToast("Storage error - using demo deck", "delete");
        }
      }

      function saveDeck() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(deck));
          console.log("Deck saved successfully:", deck.length, "cards");
        } catch (error) {
          console.error("Error saving deck:", error);
          showToast("Failed to save card!", "delete");
        }
      }

      // --- Study Logic ---
      function renderStudy() {
        if (deck.length === 0) {
          cardFrontText.textContent = "No cards!";
          cardBackText.textContent = "Go to 'Create' to add some.";
          progressText.textContent = "0 / 0";
          flashcard.classList.remove("flipped");
          return;
        }

        // Bounds check
        if (currentIndex >= deck.length) currentIndex = 0;
        if (currentIndex < 0) currentIndex = deck.length - 1;

        const card = deck[currentIndex];
        cardFrontText.textContent = card.front;
        cardBackText.textContent = card.back;
        progressText.textContent = `${currentIndex + 1} / ${deck.length}`;

        // Adjust text size for long answers (more than 100 characters)
        if (card.back.length > 100) {
          cardBackText.classList.add("long-text");
        } else {
          cardBackText.classList.remove("long-text");
        }

        if (isFlipped) {
          flashcard.classList.remove("flipped");
          isFlipped = false;
        }

        if (autoSpeakToggle.checked) {
          setTimeout(() => speak(card.front), 300);
        }
      }

      function handleCardClick(e) {
        if (deck.length === 0) return;
        // Ignore clicks on buttons inside card
        if (e.target.closest("button")) return;

        flashcard.classList.toggle("flipped");
        isFlipped = !isFlipped;

        if (isFlipped && autoSpeakToggle.checked) {
          speak(deck[currentIndex].back);
        }
      }

      function nextCard() {
        if (deck.length === 0) return;
        currentIndex = (currentIndex + 1) % deck.length;
        renderStudy();
      }

      function prevCard() {
        if (deck.length === 0) return;
        currentIndex = (currentIndex - 1 + deck.length) % deck.length;
        renderStudy();
      }

      // --- Create Logic ---
      function handleAddCard(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const frontInput = document.getElementById("newFront");
        const backInput = document.getElementById("newBack");
        const front = frontInput.value.trim();
        const back = backInput.value.trim();

        if (!front || !back) {
          showToast("Please fill both fields!", "delete");
          return;
        }

        try {
          deck.push({ id: Date.now(), front, back });
          saveDeck();

          // Reset form
          frontInput.value = "";
          backInput.value = "";
          frontInput.focus();

          // Update views
          renderManage();
          renderStudy();

          showToast("Card Added!");
        } catch (error) {
          console.error("Error adding card:", error);
          showToast("Failed to add card!", "delete");
        }
      }

      // --- Manage Logic ---
      function renderManage() {
        const list = document.getElementById("cardList");
        const count = document.getElementById("deckCount");
        list.innerHTML = "";
        count.textContent = `Total Cards: ${deck.length}`;

        if (deck.length === 0) {
          list.innerHTML = '<li class="empty-state">Deck is empty.</li>';
          return;
        }

        deck.forEach((card, index) => {
          const li = document.createElement("li");
          li.className = "list-item";
          li.innerHTML = `
                    <div class="list-text">
                        <div class="list-front">${escapeHtml(card.front)}</div>
                        <div class="list-back">${escapeHtml(card.back)}</div>
                    </div>
                    <button class="btn btn-ghost" onclick="deleteCard(${index})">
                        <svg width="20" height="20" fill="none" stroke="#ef4444" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
          list.appendChild(li);
        });
      }

      window.deleteCard = function (index) {
        deck.splice(index, 1);
        saveDeck();
        renderManage();
        // Reset study index if needed
        if (currentIndex >= deck.length)
          currentIndex = Math.max(0, deck.length - 1);
        showToast("Card Deleted!", "delete");
      };

      let clearTimer;
      function handleClearDeck() {
        const btn = document.getElementById("clearDeckBtn");
        if (btn.dataset.confirm === "true") {
          deck = [];
          saveDeck();
          renderManage();
          showToast("All Cards Cleared!", "delete");
          btn.textContent = "Clear All";
          btn.style.background = "rgba(255,255,255,0.2)";
          btn.style.color = "white";
          delete btn.dataset.confirm;
        } else {
          btn.textContent = "Confirm?";
          btn.style.background = "#b91c1c";
          btn.style.color = "white";
          btn.dataset.confirm = "true";
          clearTimer = setTimeout(() => {
            btn.textContent = "Clear All";
            btn.style.background = "rgba(255,255,255,0.2)";
            btn.style.color = "white";
            delete btn.dataset.confirm;
          }, 3000);
        }
      }

      // --- Utils ---
      function showToast(msg, type = "success") {
        const toast = document.getElementById("toast");
        let icon = "";
        if (type === "delete") {
          icon = `<svg width="20" height="20" fill="none" stroke="#ef4444" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
        } else {
          icon = `<svg width="20" height="20" fill="none" stroke="#4ade80" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
        }
        toast.innerHTML = `${icon} ${msg}`;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 2000);
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function loadVoices() {
        try {
          if (!synth) {
            console.warn("SpeechSynthesis not available");
            voiceSelect.innerHTML = '<option value="">TTS Not Available</option>';
            return;
          }

          voices = synth.getVoices();
          
          // If no voices loaded yet, try again after a delay (WebView issue)
          if (voices.length === 0) {
            setTimeout(() => {
              voices = synth.getVoices();
              if (voices.length > 0) {
                populateVoiceSelect();
              } else {
                voiceSelect.innerHTML = '<option value="">No Voices Available</option>';
              }
            }, 500);
            return;
          }

          populateVoiceSelect();
        } catch (error) {
          console.error("Error loading voices:", error);
          voiceSelect.innerHTML = '<option value="">TTS Error</option>';
        }
      }

      function populateVoiceSelect() {
        voiceSelect.innerHTML = '<option value="">Default Voice</option>';
        voices.sort((a, b) => a.name.localeCompare(b.name));
        voices.forEach((voice, index) => {
          const opt = document.createElement("option");
          opt.value = index;
          opt.textContent = `${voice.name} (${voice.lang})`;
          if (voice.default) opt.selected = true;
          voiceSelect.appendChild(opt);
        });
      }

      function speak(text) {
        if (!text) return;
        
        try {
          if (!synth) {
            console.warn("SpeechSynthesis not available");
            return;
          }

          // Cancel any ongoing speech
          if (synth.speaking) {
            synth.cancel();
            // Small delay to ensure cancellation completes
            setTimeout(() => {
              performSpeak(text);
            }, 100);
          } else {
            performSpeak(text);
          }
        } catch (error) {
          console.error("Error speaking:", error);
        }
      }

      function performSpeak(text) {
        try {
          const utter = new SpeechSynthesisUtterance(text);
          
          // Set voice if available
          const idx = voiceSelect.value;
          if (idx && voices[idx]) {
            utter.voice = voices[idx];
          }
          
          // Set default properties for better compatibility
          utter.rate = 1;
          utter.pitch = 1;
          utter.volume = 1;
          
          // Error handling
          utter.onerror = (event) => {
            console.error("Speech synthesis error:", event.error);
          };
          
          synth.speak(utter);
        } catch (error) {
          console.error("Error in performSpeak:", error);
        }
      }

      init();
    </script>
  </body>
</html>
